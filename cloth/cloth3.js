var that=(function(){
	var ctx;
    var ctx2;
	var width;
	var height;
	var canvas;
    var canvas2;
	var sin=Math.sin;
	var cos=Math.cos;


    var shad=1;
	sqrt=function(x){
		//return x;
		//return x/4+2-4/(x+4);
		return ((x/2+x/(x/2))/2+x/((x/2+x/(x/2))/2))/2;
	}
	sqrt=Math.sqrt;
    
	var vt=[];
	var vel=[];
	var N=15;
	var mx=3;
    var mz=200;
    var z=N*N-1;
	var my=200;
	var m=0;
   
	var theta=45*3.14/180;
	for(var y=0;y<N;y++){
		for(var x=0;x<N;x++){
			vt.push([
				20*cos(theta)*x+20*sin(theta)*y+100,
				20*cos(theta)*y-20*sin(theta)*x+400,
                130]);
			vel.push([0,0,0]);
		}
	}
	function gameinit(_x,_y){
	vt=[[157,109,338.9600000000001],[127.4383882585096,210.74051161661936,309.4137576760021],[107.44248176723744,280.207175644838,288.528687227676],[92.41376699769442,333.9899869397074,271.3721775752629],[80.98717841632336,377.81207834369894,255.96438831413394],[73.53739221958618,412.79207124213775,240.99908552577932],[73.58826220863142,436.45173641187137,223.25872406580797],[91.06209225282905,425.1141701610054,205.8725670390397],[110.921262428766,399.0997556081571,195.7056688416089],[133.00841161508555,365.9541570670368,187.28192218930715],[157.31863323095445,327.3507183447907,179.33468107458344],[184.2364685234518,283.11390021278703,171.36348086223097],[215.068264907081,231.0233527043179,162.87850009801065],[253.28452269776386,165.00982741035142,152.8992763719945],[308,69,139.04000000000008],[127.74331633627861,209.30824831274552,310.69825829601206],[112.4328580995051,261.406364854281,295.4719976372196],[96.91425956156614,314.2582342683881,279.6564681913737],[82.99712596587234,362.3170709240368,264.6753503377759],[71.21128541138877,404.7792837965081,250.45823173315475],[62.62415590108374,440.3835032858197,236.4847924178817],[61.10495214572174,465.2545586357695,220.04595424027443],[78.73714639304357,450.87988618769214,204.76222129036086],[98.86424447060494,422.8352042637223,195.93513546356482],[121.12240839014024,388.57832859985456,188.45229253072839],[145.05324409079645,350.1818429305195,181.31282840848073],[170.5867805637662,308.1288798967164,174.1704813722581],[197.92799184236338,262.10833507505936,166.83535378654486],[227.04373966124072,212.15763532879092,159.2639815962785],[255.22019255579696,163.14573842153547,152.0983934073739],[108.39099402325887,275.9155461133889,292.3704317453237],[97.64632821925161,311.202170930076,282.1096877841022],[84.8245922330626,353.00024560840137,269.8370621671577],[71.57147542120363,396.14196540034004,256.94103479861286],[58.80201649134609,438.3305891546933,243.86750417495847],[47.93017102796512,477.09006120318475,230.60667935431118],[43.308911967598746,506.01635588406674,215.5621307278241],[62.1861199756725,484.87775936985304,203.4930787339981],[84.00096688114762,451.8775089848431,196.05597383922228],[107.25484611524566,414.96153426344074,189.59844600289534],[131.03450947080893,376.4016320184279,183.37132654541702],[155.03052493433773,336.8891811654509,177.18835291574416],[178.9116800997707,296.9698247099626,171.05579241119423],[201.72899171375357,258.2453138197542,165.23394080137368],[220.84905561132973,225.40906869821214,160.41761880843674],[94.23593588155434,325.64234200918884,279.03953197177964],[84.93895829457905,354.4773268617892,270.8303604131693],[73.14954397380924,390.3236411530054,260.6979604751664],[59.61433268427448,430.7969978988993,249.3649718722822],[44.7265965370386,475.11503383312777,237.11328315347265],[29.161214025505714,522.7744328424425,223.85025082226608],[16.98220056776222,565.4196537018003,209.55285979296485],[41.27650124670106,527.953893241795,201.59222232935272],[67.3750110096885,484.37549337068276,195.62647924738056],[92.70335414672492,442.78998791618113,190.4528327098316],[116.77705168008116,403.44073841717267,185.29035930085246],[139.6030409018041,365.95857435507924,180.05575346767213],[161.00094995492742,330.53285716086987,174.89825540589345],[180.22703709520422,298.33435736648966,170.15846948215676],[195.81730837884007,271.9715375060902,166.3282543412599],[83.71685750896314,364.94321811625883,268.8011426565714],[74.85926765009924,390.73288995006885,261.61626774386],[63.27030838262507,423.00262189104956,252.8847457389638],[48.961873759667114,461.56587790079635,242.94604761265336],[30.985994579915666,508.3876510482968,231.7666202418672],[7.490098063619506,573.2642252926788,217.55922623214488],[-30,670,200],[18.2064754658644,576.6225792251878,198.5265102306268],[51.423681860867234,514.6937779993328,193.7310564576152],[79.51714003558695,468.3660027401742,191.034722434268],[103.95043361131773,428.6395466449561,187.33988534468367],[125.83159723057946,393.010565700398,182.83156270663835],[145.47780074675765,360.89196721882473,178.22317689331896],[162.61314070475152,332.6022842480019,174.0970887392955],[176.59489421136368,309.28004453951735,170.77576797783445],[76.4312373885098,396.83991915713676,260.7967082987909],[68.13124217991684,420.57594542589885,254.08868360135156],[57.21330167870828,449.5994931424652,246.23655799321187],[44.35254063304693,484.54320019037317,237.35848513589838],[32.80244570211272,524.3261434135736,226.49197330082634],[22.295297343184536,560.589331677347,215.44545374328777],[8.613261104130865,598.4798046984656,205.41588949726648],[31.834984858724855,561.589818856053,204.18947878896356],[54.20692687195475,526.1532774895727,205.10788496017884],[74.75310826656701,487.0724811702092,200.186424622499],[95.44181497483623,449.89418503719764,193.10066243751118],[115.07367334616123,416.7606238336419,186.1721141498704],[132.98115509361494,387.57976181633944,180.9554047315954],[148.63985747924988,362.05051743547426,177.12336343145373],[161.64389079833265,340.4592460286002,174.19171941268243],[72.58792302359302,423.51462793778484,254.65922715660466],[66.78910772829161,445.372979106177,247.74761540869113],[61.16269868298666,469.8692289675736,238.81349442209137],[56.79270027239306,495.37145485893114,228.332328922651],[49.465129387600236,520.1509669674152,219.6327961714078],[37.70963479539802,544.6081960676578,213.4253579127606],[28.939521424889985,567.2049371066527,204.41834706696946],[44.188884390452664,543.54796198657,197.3840826166308],[60.1241254973452,517.55119051128,189.00502227376185],[76.21999303446711,491.6160926733093,182.59835119869993],[91.94394599335973,464.50028232408,181.1465135201273],[108.16164763937986,436.9274549648214,181.51659252801093],[124.18201475969403,411.1261368032583,180.83962599955782],[138.3811317727862,387.87734749754463,178.9552900651792],[150.35095455516355,367.41320586272496,176.7583254007836],[71.63531208201903,447.1229993738838,250.74433490770764],[68.99004334889553,467.7912351550631,245.44285354329247],[67.68639093527679,489.3848104359677,240.5217129443065],[67.00989091360937,510.5842733422136,235.88665077835887],[63.807543931985556,530.3796786300884,229.0603097216877],[56.857342970957006,547.4364385683631,219.45980769204365],[47.35673474901801,552.7527700955828,202.31385455445184],[63.121681582424806,535.8554719327668,198.7693489115359],[78.5823241522452,517.8719700146892,196.22525785218576],[91.53549469701626,497.9873181517537,193.65057034954532],[103.30544764114164,477.2212827261954,190.90002507478422],[113.41688264097043,455.4490978394728,187.1310768028793],[122.83207296510497,433.01824080595685,183.65918444555868],[132.7458221036555,411.4152623213213,181.02559550338486],[142.524634365915,391.5588729596446,178.81310938288442],[72.15014247986741,469.266264127166,247.9199717970987],[71.0752135569721,489.42320793787826,243.50124494632325],[71.10813945142414,510.0161739021673,239.3922671617725],[71.21106710385202,530.4460508545459,235.1700569473983],[69.23192818723983,549.998255775243,229.359896804969],[63.29423885460603,566.8786112296686,219.97632317099732],[64.38762353101491,563.8102662589558,200.19838389514828],[78.01285899762101,549.3396037462971,195.81588881149986],[90.99587584387969,533.5987311188691,192.72636939118652],[101.2223164515401,515.374937910477,190.44699841658183],[109.76304967358148,495.9675332266945,188.1511255525208],[116.55030265871532,475.45955386174586,186.1944579755977],[122.77264147430625,454.37641223659153,184.3368588351732],[129.70050784333458,433.69229821932066,182.3864536785471],[137.3147782245449,414.0576169239963,180.40707925139725],[73.61553349100663,490.6563444031973,245.7510093401392],[73.4850820568402,510.5746198473233,241.85626627174625],[74.15024853922684,530.685719768616,238.03806376447582],[74.3964786844207,550.7174916599141,233.78984356273824],[72.71672285281022,570.1923090055308,228.1812044177465],[66.96214228178803,587.0103157938928,218.6982885649668],[70.4768556897831,583.2252783856268,199.32394804154683],[83.50890470958643,568.8199350876799,194.05961282368557],[96.22879011772581,553.3810419781857,190.9461265823676],[105.4362024331415,535.2102928644181,189.274454519538],[112.643219161791,516.0006526510339,187.6135150640425],[118.01956355735673,495.9277568501579,186.23007892465887],[122.60263815140611,475.4764820661886,184.8415576653018],[127.8859697395,455.28560983085396,183.28641674248902],[133.9474367236462,435.7133754540006,181.68228520515282],[75.67936255593429,511.67392699934,244.38746436398796],[75.88748554010645,531.4447427115155,240.5020443685071],[76.53850330283937,551.2959962628642,236.53809691487285],[77.01644535528816,571.0640012121055,232.10046563279002],[75.67251981926727,590.507835030153,226.78877723175447],[68.97262391385087,607.3476415182242,218.158055284408],[73.3917389773492,603.3246756019763,199.0574799447391],[85.73668580602644,588.9159869524722,192.52519150601455],[98.74841507741789,573.7917587677557,189.8763592651305],[107.26634812104525,555.4423778389922,189.54830606636713],[113.89556142949668,536.3035066029773,187.91198826021994],[118.72009518774364,516.4724182662237,186.5459871208455],[122.66590646255119,496.3770925691268,185.36941519319592],[126.95124798911554,476.45458988359593,184.01088435217773],[132.18009747025084,456.9533270718943,182.66456855279617],[77.9352410080882,532.4239377543894,243.2060512886252],[78.10856014783563,552.1026503128071,239.21282942811092],[78.57226252295796,571.7840573978584,235.0399608901677],[79.07378506433119,591.4341151561891,230.82820611808373],[77.94661780814538,610.9388705960081,226.23642829266976],[70.17925343880982,627.6352879293698,218.5229814938728],[77.43387660676692,623.1226367869435,200.45187359532716],[87.39531729011617,608.9329559692646,190.38397295493738],[100.91458847029169,594.2006018485483,188.45062795432963],[108.10398843326615,575.6415304678765,191.03218998956797],[114.11770096172759,556.6128503214187,188.8130566755495],[118.29584408879418,536.9161127304096,187.2703244148403],[121.92635734302486,517.0184489042572,186.15827353334356],[126.10443052090072,497.2831242912022,184.8318085629778],[131.08018844569906,477.8509295691932,183.62198362514513],[80.37679095980467,552.9048992307715,241.82825720781548],[80.47156801389329,572.5110076083452,237.66777395631823],[80.33227907462427,592.1569253406126,233.67069626306665],[79.71735710342071,611.7911063805083,229.79934896701803],[77.93385135400523,631.4542975004563,226.73378693995207],[72.31366481891422,647.5333105991734,216.26305961964167],[88.03039480033347,638.8923942456593,207.37441151703004],[91.06428910992574,628.7061957517673,190.4643543611786],[104.4732966241792,614.2790843662503,186.92236203108348],[107.35605567214806,595.6322857357316,193.45780988419423],[113.31521421850356,576.8258961064347,190.35221620190174],[117.09772707412316,557.2066197929701,188.2319608408501],[120.78947417421388,537.4298494990333,187.08756782956664],[125.198075759283,517.8110582184204,185.7881476715592],[130.47452445790708,498.46691986161625,184.6285570138347],[82.8875549807575,573.1225073807609,239.81770839849656],[82.4047495827336,592.7347269325684,235.62959535198962],[81.19433469810696,612.403226764137,231.85528841443346],[78.4348833743724,631.9749925637086,228.4835018748981],[74.00994904279933,651.4081168187499,226.58697015114683],[92.17265425308193,648.766532787832,218.62725359287074],[104.45475724226884,649.6531741477701,202.89501685180159],[105.48253002107273,629.7955758523897,204.33530380425043],[112.15185579592878,633.0277266207427,185.75483152808266],[106.26451851855055,615.6176332151603,193.5962546082494],[113.68790655418904,596.9481297518929,192.64867624633965],[116.65408608214935,577.4244712085081,188.9641341723655],[120.4330241576214,557.7019344595424,188.09432642410567],[124.78070746622076,538.1249230959841,187.00000141540553],[130.1009894844426,518.8354025714674,185.71858701454434],[84.77592027438698,593.1798073081711,237.65663802237046],[83.74658743890004,612.8381880165927,233.6965249401914],[81.01022956988672,632.5524383637454,230.68328608771094],[75.35042044144423,651.8406162662556,229.4690341169027],[67.26043706033938,670.2521797065118,229.16621518958277],[72.9024501771274,653.755065519715,219.67084573347955],[85.34484674961531,655.2851378067355,204.10476522207378],[90.8711283279279,638.8489354445439,194.12337982542755],[96.38731795318455,621.0414555290178,186.72018774300133],[113.50901275393619,622.6516215628717,176.32654141929274],[116.93409998430894,616.6354196030372,195.07116813043513],[117.6091691991401,597.4990192487827,189.18347215650402],[121.42766075438524,577.7940442603896,188.90749085479462],[125.8707740024146,558.2082030580398,188.66406135851824],[131.32046284158355,538.9603331477617,187.18981718059618]];
	}
    var wind_t=0;
	function physics(){
        var aspect=1;
        if(shad==4){
            aspect=1/1.9;
        }else if(shad==3){
            aspect=1/2.0;
        }
		var k=0.005;
		var g=0.001/N*10;
		var rt2=Math.sqrt(2);
		var h=20;
		if(m){vt[z]=[mx,my,mz];}
        
        var wind=0.001*Math.abs(Math.sin(wind_t/32)+Math.sin(wind_t/200)+Math.sin(wind_t/400)+Math.sin(wind_t/350));
        wind_t++;
        
        if(shad==4){
            for(var y=0;y<N;y++){
                vt[y*N][0]=vt[0][0];
                vt[y*N][1]=vt[0][1]+y*aspect*h;
                vt[y*N][2]=vt[0][2];
            }
        }
                var theta=(wind_t/914);
		for(var y=0;y<N;y++){
			for(var x=0;x<N;x++){
				if((y==0 && x==0) || (x==N-1 && shad!=4 && y==0) || (x==0 && shad==4) || (m&&x+y*N==z)){}else{
				var v=vt[x+y*N];
				
				var Fx=0;
				var Fy=0;
                var Fz=0;
				if(shad==4){
                    Fx+=wind*Math.abs(Math.cos(theta));
                    Fy-=0.8*Math.abs(wind*Math.sin(theta));
                    Fz-=0.1*(wind*Math.sin(theta));
                }
				
				
				if(x<(N-1)){
					var r=vt[x+1+y*N];
					var d=(r[0]-v[0])*(r[0]-v[0])+(r[1]-v[1])*(r[1]-v[1])+(r[2]-v[2])*(r[2]-v[2]);
					d=sqrt(d);
					// F = -k *x 
					Fx+=k*(r[0]-v[0])*(1-h/d);
					Fy+=k*(r[1]-v[1])*(1-h/d);
					Fz+=k*(r[2]-v[2])*(1-h/d);
				}
				if(x>0){
					var r=vt[x-1+y*N];
                    var d=(r[0]-v[0])*(r[0]-v[0])+(r[1]-v[1])*(r[1]-v[1])+(r[2]-v[2])*(r[2]-v[2]);
					d=sqrt(d);
					// F = -k *x
					Fx+=k*(r[0]-v[0])*(1-h/d);
					Fy+=k*(r[1]-v[1])*(1-h/d);
					Fz+=k*(r[2]-v[2])*(1-h/d);
				}
				
				if(y<N-1){
					var r=vt[x+(y+1)*N];
					var d=(r[0]-v[0])*(r[0]-v[0])+(r[1]-v[1])*(r[1]-v[1])+(r[2]-v[2])*(r[2]-v[2]);
					d=sqrt(d);
					// F = -k *x 
					Fx+=k*(r[0]-v[0])*(1-aspect*h/d);
					Fy+=k*(r[1]-v[1])*(1-aspect*h/d);
					Fz+=k*(r[2]-v[2])*(1-aspect*h/d);
				}
				if(y>0){
					var r=vt[x+(y-1)*N];
					
					var d=(r[0]-v[0])*(r[0]-v[0])+(r[1]-v[1])*(r[1]-v[1])+(r[2]-v[2])*(r[2]-v[2]);
					d=sqrt(d);
					// F = -k *x 
					Fx+=k*(r[0]-v[0])*(1-aspect*h/d);
					Fy+=k*(r[1]-v[1])*(1-aspect*h/d);
					Fz+=k*(r[2]-v[2])*(1-aspect*h/d);
				}
				
				
				
				vel[x+y*N][0]+=Fx;
				vel[x+y*N][1]+=Fy;
				vel[x+y*N][2]+=Fz;
				vel[x+y*N][0]*=0.99;
				vel[x+y*N][1]*=0.99;
				vel[x+y*N][2]*=0.99;
                
				vt[x+y*N][0]+=vel[x+y*N][0];
				vt[x+y*N][1]+=vel[x+y*N][1];
				vt[x+y*N][2]+=vel[x+y*N][2];
				vel[x+y*N][1]+=g;
				
			}
			}
		}
		if(m){vt[z]=[mx,my,mz];}
		//vt[0]=[0.5*(width-N*h),20];
		//vt[N-1]=[width-0.5*(width-N*h),20]
	}
	function keydown(e){
        //alert(JSON.stringify(vt));
        if(e.keyCode==32){
        shad=(shad+1)%7;
        }
		return;
    }
	function keyup(e){
		return;
	}
	
    var eyestrain=10000;
    
	var t=0;
    function proj(x,y,z,pm){
        return [100*x/z+width/4+pm*eyestrain/z,100*y/z+height/4];
    }
    
    function drawTexturedTriangle3( bitmap, x0, y0, x1, y1, x2, y2, u0, v0, u1, v1, u2, v2 ,z0,z1,z2) {

		// http://extremelysatisfactorytotalitarianism.com/blog/?p=2120


    var p0=proj(x0,y0,z0,-1);
 var p1=proj(x1,y1,z1,-1);
  var p2=proj(x2,y2,z2,-1);
  
  
    drawTexturedTriangle(bitmap, p0[0], p0[1], p1[0], p1[1], p2[0], p2[1], u0, v0, u1, v1, u2, v2);


  
    var p0=proj(x0,y0,z0,1);
 var p1=proj(x1,y1,z1,1);
  var p2=proj(x2,y2,z2,1);
  
    drawTexturedTriangle_2(bitmap, p0[0], p0[1], p1[0], p1[1], p2[0], p2[1], u0, v0, u1, v1, u2, v2);

	}
            
    function drawTexturedTriangle_2( bitmap, x0, y0, x1, y1, x2, y2, u0, v0, u1, v1, u2, v2 ) {

		// http://extremelysatisfactorytotalitarianism.com/blog/?p=2120

		ctx2.beginPath();
		ctx2.moveTo( x0, y0 );
		ctx2.lineTo( x1, y1 );
		ctx2.lineTo( x2, y2 );
		ctx2.closePath();

		x1 -= x0; y1 -= y0;
		x2 -= x0; y2 -= y0;

		u1 -= u0; v1 -= v0;
		u2 -= u0; v2 -= v0;

		var det = 1 / ( u1 * v2 - u2 * v1 ),

		a = ( v2 * x1 - v1 * x2 ) * det,
		b = ( v2 * y1 - v1 * y2 ) * det,
		c = ( u1 * x2 - u2 * x1 ) * det,
		d = ( u1 * y2 - u2 * y1 ) * det,

		e = x0 - a * u0 - c * v0,
		f = y0 - b * u0 - d * v0;

		ctx2.save();
		ctx2.transform( a, b, c, d, e, f );
		ctx2.clip();
		ctx2.drawImage( bitmap, 0, 0 );
		ctx2.restore();

	}
                
    function drawTexturedTriangle( bitmap, x0, y0, x1, y1, x2, y2, u0, v0, u1, v1, u2, v2 ) {

		// http://extremelysatisfactorytotalitarianism.com/blog/?p=2120

		ctx.beginPath();
		ctx.moveTo( x0, y0 );
		ctx.lineTo( x1, y1 );
		ctx.lineTo( x2, y2 );
		ctx.closePath();

		x1 -= x0; y1 -= y0;
		x2 -= x0; y2 -= y0;

		u1 -= u0; v1 -= v0;
		u2 -= u0; v2 -= v0;

		var det = 1 / ( u1 * v2 - u2 * v1 ),

		a = ( v2 * x1 - v1 * x2 ) * det,
		b = ( v2 * y1 - v1 * y2 ) * det,
		c = ( u1 * x2 - u2 * x1 ) * det,
		d = ( u1 * y2 - u2 * y1 ) * det,

		e = x0 - a * u0 - c * v0,
		f = y0 - b * u0 - d * v0;

		ctx.save();
		ctx.transform( a, b, c, d, e, f );
		ctx.clip();
		ctx.drawImage( bitmap, 0, 0 );
		ctx.restore();

	}
    
    
    var aus=new Image();
    aus.src="aus_32.png";
    var usa=new Image();
    usa.src="usa_32.png";
    
    
        var wi=32;
        var hi=32;
        
	function draw(once){
		
		physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();
		physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();
		physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();
		physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();physics();
		ctx.clearRect(0,0,width,height);
        ctx.fillStyle="rgba(0,0,0,0.2)";
        ctx2.clearRect(0,0,width,height);
        ctx2.fillStyle="rgba(0,0,0,0.2)";
        
        if(shad==6){
        
        for(var x=0;x<N-1;x++){
             for(var y=0;y<N-1;y++){
                var v=vt[x+y*N];
                var a=vt[x+1+y*N];
                var b=vt[x+(y+1)*N];
                
                var c=vt[x+1+(y+1)*N];
                
                
                ctx.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                
                ctx2.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                
                
                       
                var A = Math.abs((a[0]-v[0])*(b[1]-v[1])-(b[0]-v[0])*(b[1]-v[1]));
                C=(~~( 0.4*A+30 ));
                
                
                 if((y+x)%2){
                    ctx.fillStyle="rgba("+C*2+","+C*2+","+C*2+",1.0)";
                    ctx2.fillStyle="rgba("+C*2+","+C*2+","+C*2+",1.0)";
                 
                 }else{
                    ctx.fillStyle="rgba("+C+",0,0,1.0)";
                    ctx2.fillStyle="rgba("+C+",0,0,1.0)";
                 }
                ctx.beginPath();
                ctx2.beginPath();
                
                ctx.moveTo3(v[0],v[1],v[2]);
                ctx.lineTo3(a[0],a[1],a[2]);
                
                ctx.lineTo3(c[0],c[1],c[2]);
                ctx.lineTo3(b[0],b[1],b[2]);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle="black";
                ctx.stroke();
                
                ctx2.closePath();
                ctx2.fill();
                ctx2.strokeStyle="black";
                ctx2.stroke();
                

                    
            }
         }
         
        
        }
        if(shad==5){
         for(var x=0;x<(N-1);x++){
             for(var y=0;y<(N-1);y++){
                var v=vt[x+y*N];
                var a=vt[x+1+y*N];
                var b=vt[x+(y+1)*N];
                
                var c=vt[x+1+(y+1)*N];
             
                                
                var A = Math.abs((a[0]-v[0])*(b[1]-v[1])-(b[0]-v[0])*(b[1]-v[1]));
                C=(~~( 0.2*A+12 ));
                
                ctx.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                ctx2.fillStyle="rgba("+C+","+C+","+C+",1.0)";
            
                ctx.beginPath();
                ctx2.beginPath();
                
                ctx.moveTo3(v[0],v[1],v[2]);
                ctx.lineTo3(a[0],a[1],a[2]);
                ctx.lineTo3(b[0],b[1],b[2]);
                ctx.fill();
                ctx2.fill();
                
                A=Math.abs((a[0]-b[0])*(c[1]-b[1])-(c[0]-b[0])*(a[1]-b[1]));
                C=~~( 0.2*A+12 );
                
                ctx.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                ctx2.fillStyle="rgba("+C+","+C+","+C+",1.0)";
            


                ctx.beginPath();
                ctx2.beginPath();
                ctx.moveTo3(b[0],b[1],b[2]);
                ctx.lineTo3(a[0],a[1],a[2]);
                ctx.lineTo3(c[0],c[1],c[2]);
                ctx.fill();
                ctx2.fill();
                
            }
         }
        
        }
        if(shad==4){
        
        for(var x=0;x<(N-1);x++){
             for(var y=0;y<(N-2);y++){
                var v=vt[x+y*N];
                var a=vt[x+1+y*N];
                var b=vt[x+(y+1)*N];
                
                var c=vt[x+1+(y+1)*N];
                
                
                ctx.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                ctx2.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                if(y<=6 && x<(N*2/5)){
                    drawTexturedTriangle3( usa, v[0], v[1], a[0], a[1], b[0], b[1], wi*x/N, hi*y/N, wi*(x+1)/N, hi*y/N, wi*x/N, hi*(y+1)/N, v[2],a[2],b[2]);
                    drawTexturedTriangle3( usa, b[0], b[1], a[0], a[1], c[0], c[1], wi*x/N, hi*(y+1)/N, wi*(x+1)/N, hi*y/N, wi*(x+1)/N, hi*(y+1)/N ,b[2],a[2],c[2]);
                 }else{
                 if(y%2){
                 var A = Math.abs((a[0]-v[0])*(b[1]-v[1])-(b[0]-v[0])*(b[1]-v[1]));
                C=(~~( 0.8*A+150 ));
                ctx.fillStyle="rgba("+C+","+C+","+C+",1.0)";
            ctx2.fillStyle="rgba("+C+","+C+","+C+",1.0)";
            
                 //ctx.fillStyle="#FFFFFF";
                 
                 }else{
                 var A = Math.abs((a[0]-v[0])*(b[1]-v[1])-(b[0]-v[0])*(b[1]-v[1]));
                C=(0.8*A+150)/300;
                ctx.fillStyle="rgba("+~~(C*178)+","+~~(C*34)+","+~~(C*52)+",1.0)";
                ctx2.fillStyle="rgba("+~~(C*178)+","+~~(C*34)+","+~~(C*52)+",1.0)";
                 //ctx.fillStyle="#B22234";
                 }
                ctx.beginPath();
                ctx2.beginPath();
                ctx.moveTo3(v[0],v[1],v[2]);
                ctx.lineTo3(a[0],a[1],a[2]);
                
                ctx.lineTo3(c[0],c[1],c[2]);
                ctx.lineTo3(b[0],b[1],b[2]);
                
                ctx.fill();
                ctx2.fill();
                //ctx.strokeStyle=ctx.fillStyle;
                //ctx.stroke();
                

                    
                }
            }
         }
         
        
        
        
        }
        if(shad==3){
         for(var x=0;x<(N-1);x++){
             for(var y=0;y<(N-1);y++){
                var v=vt[x+y*N];
                var a=vt[x+1+y*N];
                var b=vt[x+(y+1)*N];
                
                var c=vt[x+1+(y+1)*N];
                /*
                   v        a
                 
                     b      
                               c
                */
                
                var A = (a[0]-v[0])*(b[1]-v[1])-(b[0]-v[0])*(b[1]-v[1]);
                var C=Math.min(Math.max(~~A,40),180)+20;
                if(A<0){
                ctx.fillStyle="#000";
                ctx2.fillStyle="#000";
                }else{
                ctx.fillStyle="rgba("+C+","+C+","+C+",1.0)";
                ctx2.fillStyle="rgba("+C+","+C+","+C+",1.0)";}
                
                if(shad==3){
                    drawTexturedTriangle3( aus, v[0], v[1], a[0], a[1], b[0], b[1], wi*x/N, hi*y/N, wi*(x+1)/N, hi*y/N, wi*x/N, hi*(y+1)/N,v[2],a[2],b[2] );
                    drawTexturedTriangle3( aus, b[0], b[1], a[0], a[1], c[0], c[1], wi*x/N, hi*(y+1)/N, wi*(x+1)/N, hi*y/N, wi*(x+1)/N, hi*(y+1)/N,b[2],a[2],c[2] );
                }
        
            }
         }
        
        } else if(shad==1 || shad==2){
            for(var xi=0;xi<N;xi++){
            ctx.beginPath();
			ctx2.beginPath();
			ctx.moveTo3(vt[xi][0],vt[xi][1],vt[xi][2]);
                var x=xi;
                for(var y=0;y<N && x<N;y++,x++){
                    var v=vt[x+y*N];
                    ctx.lineTo3(v[0],v[1],v[2]);
            
                }
                
			ctx.stroke();
            
            ctx.beginPath();
			ctx2.stroke();
            
            ctx2.beginPath();
			ctx.moveTo3(vt[xi+(N-1)*N][0],vt[xi+(N-1)*N][1],vt[xi+(N-1)*N][2]);
            if(xi!=0){
            x=xi;
            for(var y=N-1;y>=0 && x<N;y--,x++){
                    var v=vt[x+y*N];
                    ctx.lineTo3(v[0],v[1],v[2]);
            
                }
                
			ctx.stroke();
            ctx2.stroke();
            
            }
            
            }
            for(var yi=1;yi<N;yi++){
            ctx.beginPath();
			ctx2.beginPath();
			ctx.moveTo3(vt[yi*N][0],vt[yi*N][1],vt[yi*N][2]);
                var y=yi;
                for(var x=0;x<N && y<N;y++,x++){
                    var v=vt[x+y*N];
                    ctx.lineTo3(v[0],v[1],v[2]);
            
                }
                
			ctx.stroke();
            
            ctx.beginPath();
			ctx2.stroke();
            
            ctx2.beginPath();
			ctx.moveTo3(vt[yi*N][0],vt[yi*N][1],vt[yi*N][2]);
                y=yi;
                for(var x=0;x<N && y>=0;y--,x++){
                    var v=vt[x+y*N];
                    ctx.lineTo3(v[0],v[1],v[2]);
            
                }
                
			ctx.stroke();
            ctx2.stroke();
            
            
            
            }
        }
        if(shad==0 || shad==1){
        ctx.strokeStyle="black";	
		ctx.lineWidth=0.6;
		ctx2.strokeStyle="black";	
		ctx2.lineWidth=0.6;
		for(var y=0;y<N;y++){
			ctx.beginPath();
			ctx2.beginPath();
			ctx.moveTo3(vt[y*N][0],vt[y*N][1],vt[y*N][2]);
			for(var x=0;x<N;x++){
				var v=vt[x+y*N];
				ctx.lineTo3(v[0],v[1],v[2]);
			}
			ctx.stroke();
            ctx2.stroke();
		}
		for(var x=0;x<N;x++){
			ctx.beginPath();
			ctx2.beginPath();
			ctx.moveTo3(vt[x][0],vt[x][1],vt[x][2]);
			for(var y=0;y<N;y++){
				var v=vt[x+y*N];
				ctx.lineTo3(v[0],v[1],v[2]);
			}
			ctx.stroke();
            ctx2.stroke();
		}
		
        }
        
        
        //draw 3D Cursor
        var cs=40;
        var csz=10;
        ctx.beginPath();
        ctx2.beginPath();
			ctx.moveTo3(mx,my,mz);
            ctx.lineTo3(mx+cs,my,mz);
            ctx.lineTo3(mx+cs,my+cs,mz);
            ctx.lineTo3(mx,my+cs,mz);
            ctx.closePath();
            ctx2.closePath();
        ctx.stroke();
        ctx2.stroke();
        
        
        
         ctx.beginPath();
        ctx2.beginPath();
			ctx.moveTo3(mx,my,mz+csz);
            ctx.lineTo3(mx+cs,my,mz+csz);
            ctx.lineTo3(mx+cs,my+cs,mz+csz);
            ctx.lineTo3(mx,my+cs,mz+csz);
            ctx.closePath();
            ctx2.closePath();
        ctx.stroke();
        ctx2.stroke();
        
        
         ctx.beginPath();
        ctx2.beginPath();
			ctx.moveTo3(mx+cs,my,mz+csz);
			ctx.lineTo3(mx+cs,my,mz);
            ctx.closePath();
            ctx2.closePath();
        ctx.stroke();
        ctx2.stroke();
        
         ctx.beginPath();
        ctx2.beginPath();
			ctx.moveTo3(mx+cs,my+cs,mz+csz);
			ctx.lineTo3(mx+cs,my+cs,mz);
            ctx.closePath();
            ctx2.closePath();
        ctx.stroke();
        ctx2.stroke();
        
         ctx.beginPath();
        ctx2.beginPath();
			ctx.moveTo3(mx,my+cs,mz+csz);
			ctx.lineTo3(mx,my+cs,mz);
            ctx.closePath();
            ctx2.closePath();
        ctx.stroke();
        ctx2.stroke();
        
         ctx.beginPath();
        ctx2.beginPath();
			ctx.moveTo3(mx,my,mz+csz);
			ctx.lineTo3(mx,my,mz);
            ctx.closePath();
            ctx2.closePath();
        ctx.stroke();
        ctx2.stroke();
        
        
        ctx.fillStyle="black";
        ctx.beginPath();
        var p=proj(mx,my,mz,-1);
        ctx.arc(p[0], p[1], 3, 0, Math.PI*2, true); 
        ctx.closePath();
        ctx.fill();

 
        ctx2.fillStyle="black";
        ctx2.beginPath();
        p=proj(mx,my,mz,1);
        ctx2.arc(p[0], p[1], 3, 0, Math.PI*2, true); 
        ctx2.closePath();
        ctx2.fill();


        
		if(!once){
			setTimeout(draw,0);
		}
	}
    
    var scaleconst = 0.001;
if (/AppleWebKit\/[\d]+\.[\d]+\+/.test(navigator.userAgent)) {
    scaleconst = 0.01;
}
if (/Firefox/.test(navigator.userAgent)) {
    scaleconst = 0.01;
}
if (/Opera/.test(navigator.userAgent)) {
    scaleconst = 0.03
}
if (!/Mac OS X/.test(navigator.userAgent)) {
    scaleconst = 0.1
}


	function init(fullscreen){
		if(fullscreen){
		window.onresize=function(){
			canvas.width=width=window.innerWidth/2;
			canvas.height=height=window.innerHeight;
            
			canvas2.width=width=window.innerWidth/2;
			canvas2.height=height=window.innerHeight;
			draw(true);
		}
		
		canvas.width=width=window.innerWidth/2;
		canvas.height=height=window.innerHeight;
		canvas2.width=width=window.innerWidth/2;
		canvas2.height=height=window.innerHeight;
		
        }
		else{
			width=canvas.width;
			height=canvas.height;
		}
		window.onkeydown=keydown;
		window.onkeyup=keyup;
		window.onmousemove=function(e){
			mx=e.x;
			my=e.y;
		}
        window.onmousewheel=function(e){
            mz+=e.wheelDelta*scaleconst;
        };
		window.onmousedown=function(e){
        
            var mind2=1000000000;
            var mini=0;
            var imax=N*N;
            if(shad==4){
                imax=(N-1)*N;
            }
            for(var i=0;i<imax;i++){
                var d2=(vt[i][0]-mx)*(vt[i][0]-mx)+(vt[i][1]-my)*(vt[i][1]-my)+(vt[i][2]-mz)*(vt[i][2]-mz);
                if(d2<mind2){
                    mind2=d2;
                    mini=i;
                }
            }
            z=mini;
            if(shad==4){
                if(z%N==0){
                    z=0;
                }
            }
			m=1;
		}
		window.onmouseup=function(e){
			m=0;
		}
		gameinit(0,0);
		draw();
	}
	var that = {
		"ver":1,
		"init":function(c,c2,fullscreen){
			canvas=c;
            canvas2=c2;
			if(canvas.getContext){
				width=canvas.width;
				height=canvas.height;
				ctx=canvas.getContext("2d");
                ctx2=canvas2.getContext("2d");
                canvas.style.position="fixed";
                canvas2.style.position="fixed";
                canvas.style.top=canvas.style.left="0px";
                canvas2.style.top=canvas2.style.right="0px";
                canvas.style.cursor="none";
                canvas2.style.cursor="none";
                
                ctx.lineTo3=function(x,y,z){
                    if(z>0){
                        ctx.lineTo(100*x/z+width/4-eyestrain/z,100*y/z+height/4);
                        ctx2.lineTo(100*x/z+width/4+eyestrain/z,100*y/z+height/4);
                    
                    }else{
                        //Z LESS THAN ZEro!!!!
                    }
                };
                ctx.moveTo3=function(x,y,z){
                    if(z>0){
                        ctx.moveTo(100*x/z+width/4-eyestrain/z,100*y/z+height/4);
                        ctx2.moveTo(100*x/z+width/4+eyestrain/z,100*y/z+height/4);
                    
                    }else{
                        //Z LESS THAN ZEro!!!!
                    }
                };
                
				init(fullscreen);
			}else{
				return alert("Not supported in lame browsers!");
			}
		}
	};
	
	return that;
})();

that.init(document.getElementById("canvas"),document.getElementById("canvas2"),true);